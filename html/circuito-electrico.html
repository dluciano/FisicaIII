<div class="circuito-electrico">
    <div class="controls-container">
        <button id="add-power">+ Fuente</button>
        <button id="add-resistor">+ Resistencia</button>
        <button id="toggle-wiring-mode">Modo Cableado</button>
        <button id="simulate">Simular</button>
    </div>
    <div class="canvas">

    </div>
    <script>
        // TODO: Fix Connections After Dragging
        var c = $('.connection');
        setInterval(function () {
            c.connections('update');
        }, 500);

        $(function () {
            var eM = new elementManager($('.canvas'));
            var WIRING_MODE_ON = false;

            $('#add-resistor').click(function () {
                eM.addResistor(prompt("Ingrese la cantidad de ohmios: "))
            });

            $('#add-power').click(function () {
                eM.addPower(prompt("Ingrese la cantidad de voltios: "))
            });

            $(document).on('click', '.circuit.element', function () {
                if (!WIRING_MODE_ON)
                    return;

                // TODO: Handle double clicking an element, for idiots.

                var ce = $(this);
                var starting = $('.selected-element');

                if (starting.length === 0) {
                    ce.toggleClass('selected-element');
                    return;
                }

                eM.addConnector(starting.attr('id'), ce.attr('id'));

                starting.removeClass('selected-element');
                starting.connections({to: '#' + ce.attr('id'), 'class': 'related'});
            });

            $('#toggle-wiring-mode').click(function () {
                WIRING_MODE_ON = !WIRING_MODE_ON;

                $(this).toggleClass('wiring-enabled');

                if (!WIRING_MODE_ON)
                    $('.selected-element').removeClass('selected-element');
            });

            //$('#add-connector').click(eM.addConnector());
        });

        function elementManager(canvas) {
            var self = this;
            self.resistors = [];
            self.powers = [];
            self.connectors = [];

            self.canvas = canvas;

            self.lastResistorId = 0;
            self.lastPowerId = 0;
            self.lastConnectorId = 0;

            function addToCanvas(vm) {
                self.canvas.append($(vm.render()).draggable());
            }

            self.addResistor = function (ohms) {
                if(isNaN(ohms) || ohms <= 0)
                    return;
                var r = new resistor("R" + ++self.lastResistorId, ohms);
                self.resistors.push(r);
                addToCanvas(new resistorVM(r));
            };

            self.addPower = function (volts) {
                if(isNaN(volts) || volts <= 0)
                    return;
                var p = new power("V" + ++self.lastPowerId, volts);
                self.powers.push(p);
                addToCanvas(new powerVM(p));
            };

            self.addConnector = function (id1, id2) {
                var c = new connector("C" + ++self.lastConnectorId, searchStoredElement(id1), searchStoredElement(id2));

                // TODO: Use ConnectorVM to render lines, actually on click.

                self.connectors.push(c);
            };

            function searchStoredElement(id) {
                try {
                    return Enumerable.From(self.resistors).Single(function (r) {
                        return r.name == id.toUpperCase();
                    });
                } catch (e1) {
                    try {
                        return Enumerable.From(self.powers).Single(function (p) {
                            return p.name == id.toUpperCase();
                        });
                    } catch (e2) {
                        window.console.log("The element #" + id + " does not exists. " +
                        e1.message + " " + e2.message);
                        throw e2;
                    }
                }
            }

            return this;
        }

        function resistor(name, value) {
            this.name = name;
            this.value = value;

            return this;
        }

        function resistorVM(resistor) {
            var self = this;
            self.resistor = resistor;
            self.render = function () {
                return '<figure id="' + self.resistor.name.toLowerCase() + '" class="circuit element resistor"><br><br>' +
                        self.resistor.name + " " +
                        self.resistor.value + "Î©" +
                        '</figure>';
            }
        }

        function power(name, value) {
            this.name = name;
            this.value = value;

            return this;
        }

        function powerVM(power) {
            var self = this;
            self.power = power;
            self.render = function () {
                return '<figure id="' + self.power.name.toLowerCase() + '" class="circuit element power"><br><br>' +
                        self.power.name + " " +
                        self.power.value + "V" +
                        '</figure>';
            }
        }

        function connector(name, e1, e2) {
            this.name = name;
            this.intensity = null;
            this.voltage = null;
            this.e1 = e1;
            this.e2 = e2;

            return this;
        }

        function connectorVM(connector) {
            var self = this;
            self.connector = connector;
            self.render = function () {
                return '<figure id="' + self.connector.name.toLowerCase() + '" class="circuit element connector"><br><br>' +
                        self.connector.name +
                        self.connector.intensity +
                        self.connector.voltage +
                        '</figure>';
            }
        }

    </script>
</div>